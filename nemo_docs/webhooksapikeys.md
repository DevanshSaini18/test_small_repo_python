## Webhooks & API Keys

This section describes how API keys and webhooks are represented, created, authenticated, and consumed in the platform.

### Data models
- APIKey (app/models.py)
  - Fields: id, key (unique string), name, organization_id, is_active (bool), last_used_at (datetime), created_at, expires_at
  - Relationship: belongs to Organization
- Webhook (app/models.py)
  - Fields: id, url, events (comma-separated string of event types), is_active, secret (string for signature verification), organization_id, created_at
  - Relationship: belongs to Organization

Schemas (app/schemas.py)
- APIKeyCreate: name, optional expires_at
- APIKeyRead: id, key, name, is_active, created_at, expires_at, last_used_at
- WebhookCreate: url, events, optional secret
- WebhookRead / WebhookUpdate: id, url, events, is_active, organization_id, created_at

### Creation and storage (services)
- create_api_key(db, APIKeyCreate, org_id) (app/services.py)
  - Uses auth.generate_api_key() to produce a secure key prefixed with "sk_" (app/auth.py)
  - Persists APIKey record with expires_at and organization association
- create_webhook(db, WebhookCreate, org_id) (app/services.py)
  - Persists webhook url, events, secret and organization linkage

### API surface (routes)
- API Key endpoints (app/routes.py)
  - POST /api-keys — create new API key (Admin only via require_role(UserRole.ADMIN))
  - GET /api-keys — list API keys for organization (Admin only)
- Webhook endpoints (app/routes.py)
  - POST /webhooks — create webhook (Admin only)
  - GET /webhooks — list webhooks (Admin only)

Request authentication: endpoints accept either JWT Bearer tokens (Authorization: Bearer <token>) or API keys (X-API-Key: <api_key>) as described in docs/api-reference.md and implemented in dependencies.py.

### API key verification and lifecycle
- verify_api_key dependency (app/dependencies.py)
  - Reads X-API-Key header, looks up active APIKey
  - Checks expires_at against current time; updates APIKey.last_used_at on success
  - Resolves and returns associated Organization (and ensures org is active)
- Keys are generated by generate_api_key() (app/auth.py) and stored as the full key (sk_...)
- APIKey model tracks last_used_at to support auditing/rotation and expires_at for automatic invalidation

### Webhook contract & signature verification
- Event types (docs/api-reference.md): item.created, item.updated, item.deleted, comment.created, user.added
- Payload format (docs/api-reference.md): JSON with keys event, timestamp, organization_id, data
- Signature: requests sent to webhook endpoints include X-Signature header containing an HMAC-SHA256 signature computed with the webhook secret; docs/api-reference.md specifies HMAC-SHA256 verification using the stored secret

### Integration notes
- Creation/listing of keys and webhooks require admin role (routes + dependencies)
- Webhooks store secret per organization for signature verification; platform records events (services.log_activity) that can be mapped to webhook dispatch (no dispatcher shown in code but contract defined in docs)

Source files: app/models.py, app/schemas.py, app/services.py, app/routes.py, app/dependencies.py, app/auth.py, docs/api-reference.md, README.md


## Source Files
- app/models.py
- app/schemas.py
- app/services.py
- app/routes.py
- app/dependencies.py
- app/auth.py
- docs/api-reference.md
- README.md